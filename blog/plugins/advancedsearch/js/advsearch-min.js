function go_search(){searchresultnb.innerHTML="&nbsp;&nbsp;&nbsp;";searchresults.parentNode.className="loading";xmlhttp.open("POST","index.php?ajax_advsearch",true);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send("q="+JSON.stringify(recherche))}function display_results(e){searchresults.parentNode.style.display="block";var t=[];if(e&&e!=""){e=JSON.parse(e)}if(!e||e==""||e.length==0){searchresults.innerHTML="Aucun résultat pour cette recherche";searchresultnb.innerHTML="0";return false}searchresultnb.innerHTML=e.length-1;for(i=1;i<e.length;i++){template=e[i].tpl?e[i].tpl:e[0].tpl;template=template.replace("#art_date",e[i].date);template=template.replace("#art_title",e[i].title);template=template.replace("#art_url",e[i].url);if(e[i].vignette)template=template.replace("#art_vignette",e[i].vignette);if(e[i].chapo)template=template.replace("#art_chapo",e[i].chapo);t.push(template)}searchresults.innerHTML=t.join("")}function add_text_click(e){var t=e&&e.target?e.target:window.event.srcElement;var n=document.getElementById("sp-text-i");if(n.value=="")return;add_search(t.parentNode.id,n.value,n.value)}function add_date_click(e){var t=e&&e.target?e.target:window.event.srcElement;var n=document.getElementById("sp-date-from");var r=document.getElementById("sp-date-from-y");var i=document.getElementById("sp-date-to");var s=document.getElementById("sp-date-to-y");if(n.value==i.value&&r.value==s.value){add_search(t.parentNode.id,""+r.value+n.value+"-"+s.value+i.value,"en "+n.options[n.selectedIndex].text+" "+r.options[r.selectedIndex].text)}else{add_search(t.parentNode.id,""+r.value+n.value+"-"+s.value+i.value,"de "+n.options[n.selectedIndex].text+" "+r.options[r.selectedIndex].text+" à "+i.options[i.selectedIndex].text+" "+s.options[s.selectedIndex].text)}}function add_tag_click(e){var t=e&&e.target?e.target:window.event.srcElement;add_search(t.parentNode.id,t.innerHTML,t.innerHTML)}function add_cat_click(e){var t=e.target||window.event.srcElement;add_search(t.parentNode.id,t.getAttribute("catid"),t.innerHTML)}function get_cat_label(e){switch(e.substring(0,7)){case"sp-tags":label=e=="sp-tags"?"Mot clé":e.substring(8).replace("_"," ");break;case"sp-cats":label="Catégorie";break;case"sp-date":label="Publié";break;case"sp-text":label="Contenant";break;default:label="yu???"}return label}function add_search(e,t,n){itemid=-1;searchlist.style.display="block";found=false;for(i=recherche.length-1;i>=0;i--)if(recherche[i]&&recherche[i].cat==e){itemid=i;for(j=0;j<recherche[i].values.length;j++)if(recherche[i].values[j]==t)return false;break}if(itemid<0){itemid=recherche.length;cat_label=get_cat_label(e);recherche[itemid]={cat:e,labels:[],values:[]};searchlist.innerHTML+='<div id="sl-div-'+itemid+'">'+html_img_et+'<div class="sl-lbl">'+cat_label+' :</div><span class="sl-itm" itemid="'+itemid+","+recherche[itemid].values.length+'"><span>'+n+html_img_del+"</span></span></div>"}else{document.getElementById("sl-div-"+itemid).innerHTML+='<span class="sl-itm" itemid="'+itemid+","+recherche[itemid].values.length+'">'+html_img_ou+"<span>"+n+html_img_del+"</span></span>"}recherche[itemid].values.push(t);recherche[itemid].labels.push(n);go_search()}function switch_search(e){obj=e.parentNode;itemid_old=obj.getAttribute("itemid").split(",");itemid_new=recherche.length;recherche[itemid_new]={cat:recherche[itemid_old[0]].cat,labels:[],values:[]};cat_label=get_cat_label(recherche[itemid_new].cat);recherche[itemid_new].values.push(recherche[itemid_old[0]].values[itemid_old[1]]);recherche[itemid_new].labels.push(recherche[itemid_old[0]].labels[itemid_old[1]]);del_search(e,true);searchlist.innerHTML+='<div id="sl-div-'+itemid_new+'">'+html_img_et+'<div class="sl-lbl">'+cat_label+' :</div><span class="sl-itm" itemid="'+itemid_new+',0"><span>'+recherche[itemid_new].labels[0]+html_img_del+"</span></span></div>"}function del_search(e,t){t=t||false;if(!t)e=e.parentNode;e=e.parentNode;var t=e.parentNode;var n=e.getAttribute("itemid").split(",");t.removeChild(e);if(recherche[n[0]].labels.length==1){delete recherche[n[0]]}else{delete recherche[n[0]].labels[n[1]];var r=false;for(i=0;i<recherche[n[0]].labels.length;i++)if(recherche[n[0]].labels[i])r=true;if(r){delete recherche[n[0]].values[n[1]]}else{delete recherche[n[0]]}}if(t.getElementsByTagName("span").length<=1){t.parentNode.removeChild(t);if(searchlist.getElementsByTagName("div").length==0){recherche=[];searchlist.style.display="none";searchresult.style.display="none";return false}}go_search()}var searchpool=document.getElementById("searchpool");var searchlist=document.getElementById("searchlist");var searchresults=document.getElementById("searchresultbox");var searchresultnb=document.getElementById("searchresultnb");var recherche=[];divtags=searchpool.getElementsByTagName("div");for(i=0;i<divtags.length;i++){divid=divtags[i].id.substring(0,7);if(divid=="sp-tags"){taglist=divtags[i].getElementsByTagName("span");for(j=0;j<taglist.length;j++)taglist[j].onclick=add_tag_click;delete taglist}else if(divid=="sp-cats"){taglist=divtags[i].getElementsByTagName("span");for(j=0;j<taglist.length;j++)taglist[j].onclick=add_cat_click;delete taglist}delete divid}delete divtags;document.getElementById("btn_add_date").onclick=add_date_click;document.getElementById("btn_add_text").onclick=add_text_click;document.getElementById("sp-date-to").selectedIndex=11;document.getElementById("sp-date-to-y").value=(new Date).getFullYear();var html_img_del='<div onclick="del_search(this)" onmouseover="this.parentNode.className=\'hover\'" onmouseout="this.parentNode.className=\'\' "class="sl-del"></div>';var html_img_ou='<div onclick="switch_search(this)" class="sl-ou" onmouseover="this.className=\'sl-ou hover\'" onmouseout="this.className=\'sl-ou\'"></div>';var html_img_et='<div class="sl-et"></div>';var xmlhttp;if(window.XMLHttpRequest){xmlhttp=new XMLHttpRequest}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4){if(xmlhttp.status==200){display_results(xmlhttp.responseText);searchresults.parentNode.className=""}else{searchresults.parentNode.className="error";searchresults.innerHTML="Une erreur est survenue pendant la recherche"}}}